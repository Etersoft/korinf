#!/bin/sh -x
##
#  Korinf project
#
#  Publish WINE@Etersoft product for client by task file
#
#  Copyright (c) Etersoft <http://etersoft.ru> 2006, 2007, 2009
#  Copyright (c) Vitaly Lipatov <lav@etersoft.ru> 2006, 2007, 2009
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.

#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.

#  You should have received a copy of the GNU Affero General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

# Выполняет сборку по первому заказу в списке
# Отправляет на реальный адрес только с параметром --real /путь
# Также отладку можно включить, создав файл arobot.sh.debug
# (c) Etersoft
# 08.06.2006, 09.06.06, 28.02.07, 09.03.07, 15.12.07, 2008
# FIXME: если в имени запятая, разделяет на два адреса
#

# TARGETDIR - user download dir on the site
# TYPE - CAD/SQL/Network/Local/Network Lite/SQL Unique
prepare_wine_etersoft()
{
	# PRODUCT_name - sql/network/local
	PRODUCT_name=`echo "$TYPE" | sed -e "s| ||g" | tr A-Z a-z`

	if [ "$PROJECTVERSION" = "1.0.11" ] ; then
		[ "$TYPE_LICENSE" = "DemoTerminal" ] && TYPE_LICENSE="Demo"
	fi

	LICENSE_name=`echo "$TYPE_LICENSE" | sed -e "s| ||g" | tr "[A-Z]" "[a-z]"`

	# due ( below
	export FTPDIR=$TARGETDIR/$TYPE-$PROJECTVERSION/$DIST

	# Можем стирать только каталог дистрибутива, а не весь
	test -e $FTPDIR && rm -rf $FTPDIR
	mkdir -p $FTPDIR/ $FTPDIR/extra

	echo >> $ALOGDIR/autobuild.report.log
	echo "Build $TYPE for $ETERREGNUM in $DIST" >> $ALOGDIR/autobuild.report.log

	check_and_refresh_package_wine $PVTLOCAL/$DIST wine-etersoft-${PRODUCT_name}
	check_and_refresh_package_wine $PUBLOCAL/WINE/$DIST wine-etersoft

	# skip on FreeBSD
	if ! echo "$DIST" | grep -q "FreeBSD" ; then
		if [ "$PROJECTVERSION" != "1.0.11" ] ; then
			check_and_refresh_component bin-hasp $PUBLOCAL/HASP/$DIST haspd
		fi

		if [ "$TYPE" != "Local" ] ; then
			#check_and_refresh_package_wine $PUBLOCAL/CIFS/$DIST etercifs
			check_and_refresh_component bin-cifs $PUBLOCAL/CIFS/$DIST etercifs
		fi
		#check_and_refresh_package_wine $PUBLOCAL/WINE/$DIST fonts-ttf-liberation
	fi

	# Get file list
	PRIVFILES=`find -L $PVTLOCAL/$DIST -maxdepth 1 -type f`
	PUB1FILES=`find -L $PUBLOCAL/WINE/$DIST -maxdepth 1 -type f`
	#PUB2FILES=`find -L $PUBLOCAL/fonts/$DIST -maxdepth 1 -type f`
	# CIFS
	PUB2FILES=`find -L $PUBLOCAL/CIFS/$DIST -maxdepth 1 -type f`
	# extra
	PUB3FILES=`find -L $PUBLOCAL/WINE/$DIST/extra -maxdepth 1 -type f`
	# HASP
	# TODO: copy haspd-modules to extra
	if [ "$PROJECTVERSION" != "1.0.11" ] ; then
		PUB4FILES=`find -L $PUBLOCAL/HASP/$DIST -maxdepth 1 -type f`
	else
		PUB4FILES=
	fi

	if [ "$TYPE" = "CAD" ] ; then
		# GL for CAD
		PUB5FILES=`find -L $PUBLOCAL/WINE/$DIST/extra -maxdepth 1 -type f -name "wine-etersoft-gl*"`
	else
		PUB5FILES=
	fi

	# Нужно скопировать файлы
	for i in $PRIVFILES $PUB1FILES $PUB2FILES $PUB4FILES $PUB5FILES; do
		# try create hard link firstly
		cp -fl $i $FTPDIR || cp -f $i $FTPDIR || fatal "Can't copy $i"
	done

	# Копируем дополнительные в extra
	for i in $PUB3FILES; do
		# try create hard link firstly
		cp -fl $i $FTPDIR/extra/ || cp -f $i $FTPDIR/extra/ || fatal "Can't copy $i"
	done

	create_license $FTPDIR/WINE-ETERSOFT.LIC $AROBOTDIR/dsa/wine-etersoft.dsa

	# Ещё раз проверяем наличие обязательных пакетов
	# Check package files
	check_package $FTPDIR wine-etersoft

	# skip on FreeBSD
	if ! echo "$DIST" | grep -q "FreeBSD" ; then
		check_package $FTPDIR haspd
		check_package $FTPDIR haspd-modules
		if [ "$TYPE" != "Local" ] ; then
			check_package $FTPDIR etercifs
		fi
	fi

	check_package $FTPDIR wine-etersoft-${PRODUCT_name}
	check_package $FTPDIR fonts-ttf-liberation

	if [ "$TYPE" = "CAD" ] ; then
		check_package $FTPDIR wine-etersoft-gl
	fi

	# вставляем регистрационный номер в readme и в каталог
	DOCS=$PVTLOCAL/../docs
	sed -e "s/XXXX-XXXX/$ETERREGNUM/g" <$DOCS/README_$TYPE.html >$FTPDIR/README.html || fatal "readme copying"
	sed -e "s/XXXX-XXXX/$ETERREGNUM/g" <$DOCS/license_${PRODUCT_name}_${LICENSE_name}.html >$FTPDIR/license.html || fatal "license copying"
	cp -f $DOCS/${PRODUCT_name}_manual.html $FTPDIR/manual.html || fatal "manual copying"
}


# Ошибка: не ловятся ошибки отсюда
prepare_wine_etersoft_mail_html()
{
	local FILETO BETA HTMLTO=$FTPDIR/download.html
	FILETO=$1
	>$FILETO
	>$HTMLTO
	NAME="$(get_dear_from_fio "$FULLNAME" "покупатель")"
	BETA=""
	# FIXME: is it used?
	if [ "$RELEASECANDIDAT" = "1" ] ; then
		BETA="
		<p class="comment_warning" align="center">Это бета-версия продукта, используйте её с осторожностью!
<br>Устанавливайте в повседневное использование только после тестирования!
<br>Создавайте резервные копии чаще!</p>
"
	fi

CIFSTEXT=""
if [ "$TYPE" != "Local" ] ; then
fatal "Нужно переписать!!!"
CIFSTEXT="
Для обеспечения взаимодействия по протоколу CIFS с сервером
SAMBA или Windows Server - пакет с модулем ядра Linux CIFS:
	$PUBDOWNLOAD1CIFS
"
fi

if [ "$TYPE_LICENSE" = "Demo" ] || [ "$TYPE_LICENSE" = "DemoTerminal" ] ; then
	THANKTEXT="Благодарим Вас за внимание к нашему продукту."
else
	THANKTEXT="Благодарим Вас за покупку!"
fi

	cat >>$FILETO <<EOF
${DEAR} ${NAME}!

Ваш заказ по сборке Продукта ${PRODUCT} (релиз $PROJECTVERSION)
для системы ${TEXTDIST} выполнен.
Регистрационный номер Продукта: ${ETERREGNUM}.

Ссылки для скачивания файлов Продукта находятся здесь:
${DOWNLOADDIR}/$TYPE-$PROJECTVERSION/$DIST/download.html

По вопросам использования продукта пишите на support@etersoft.ru, указав
в ТЕМЕ (Subject) письма регистрационный номер.

Пожалуйста, отвечайте на это письмо только
при возникновении затруднений со скачиванием файлов.

$THANKTEXT
-- 
Команда разработчиков
Etersoft, 2010
EOF

cat >>$HTMLTO <<EOF
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <title>Сссылки для получения продукта ${PRODUCT}</title>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<style type="text/css">
  comment_warning {
    background-color: #FF0000;
    color:Black;
    font-size:12px;
    padding:10px;
  };
  comment_note {
    background-color: #FFFF00;
    color:Black;
    font-size:12px;
    padding:10px;
  };
</style>

<body>
<center>
<table border="0" cellspacing="0" cellpadding="0" width="770">
<tr>
	<td valign="middle"><span class="title">Etersoft - привычные программы на свободной платформе</span></td>
	<td valign="bottom" align="right"><br /><span class="date">Вторник, 07 Июль 2009 &nbsp;</span></td>
</tr>
</table>

<table border="0" cellspacing="0" cellpadding="0" width="774">
	<tr><td bgcolor="#333333" colspan="3">
	</tr>

<h2>Получение продукта ${PRODUCT}</h2>
<p>
${DEAR} ${NAME}!

Сборка Продукта ${PRODUCT} (релиз $PROJECTVERSION) для системы ${TEXTDIST}.
${BETA}
Регистрационный номер Продукта: ${ETERREGNUM}.

Для получения Продукта необходимо скачать файлы по приведённым ссылкам, в их числе:
<ul>
 <li>пакеты Продукта (wine-etersoft, wine-etersoft-$PRODUCT_name)</li>
 <li>файл лицензии WINE-ETERSOFT.LIC</li>
 <li>документацию (файл manual.html)</li>
 <li>пакет драйверами аппаратных ключей защиты HASP 4/HL/SRM, Smartkey 3 Eutron и SafeNet Sentinel (hasp);</li>
 <li>пакет со свободными шрифтами Liberation (fonts-ttf-liberation). Во многих дистрибутивах он уже есть (в Ubuntu называется ttf-liberation).</li>
</ul>

Ссылки для скачивания файлов вашего экземпляра Продукта по протоколу FTP:
	$(printHTMLURL "$FTPDIR" "$DOWNLOADDIR/$TYPE-$PROJECTVERSION/$DIST" `find -L $FTPDIR -maxdepth 1 -type f | sort` >>$FILETO || fatal "Error with files (files are missed) ")
<br>(действительны в течение 4 суток)

Ссылки для скачивания файлов вашего экземпляра Продукта по протоколу HTTP:
	$(printHTMLURL "$FTPDIR" "${DOWNLOADDIR/ftp/http}/$TYPE-$PROJECTVERSION/$DIST" `find -L $FTPDIR -maxdepth 1 -type f | sort` >>$FILETO || fatal "Error with files (files are missed) ")
<br>(действительны в течение 4 суток)

<p style="comment_note">
ОБРАТИТЕ ВНИМАНИЕ!
Файл лицензии <a href=$(printHTMLURL "$FTPDIR" "$DOWNLOADDIR/$TYPE-$PROJECTVERSION/$DIST" $FTPDIR/WINE-ETERSOFT.LIC >>$FILETO || fatal "Error with WINE-ETERSOFT.LIC ")>WINE-ETERSOFT.LIC</a> необходимо расположить в каталоге /etc/wine, ~/.wine или C:\WINDOWS\INF.
</p>

$CIFSTEXT

Для полного соответствия шрифтов в программах можно <a href=$PUBDOWNLOAD1FONTS>скачать</a> и установить <a href=$PUBDOWNLOAD1FONTS>пакет fonts-ttf-ms</a>,
содержащий шрифты MS Core Fonts.

Также Вы можете напрямую <a href=$DOWNLOADDIR/$TYPE-$PROJECTVERSION/$DIST>зайти в каталог</a>, чтобы загрузить файлы открытой и закрытой части.

Обязательно ознакомьтесь с известными проблемами в текущей сборке:
http://wiki.etersoft.ru/WINE/knownbugs

Ответы на частые вопросы смотрите на <a href=http://etersoft.ru/wine/faq>http://etersoft.ru/wine/faq</a>.

По вопросам использования продукта пишите <a href="mailto:support@etersoft.ru">в службу поддержки</a>, указав
в ТЕМЕ (Subject) письма регистрационный номер ${ETERREGNUM}.

$THANKTEXT
<br>
<i>Команда разработчиков Etersoft, 2010</i>

</table>
</body>
</html>
EOF
}

# Ошибка: не ловятся ошибки отсюда
prepare_wine_etersoft_mail()
{
	local FILETO BETA NAME
	FILETO=$1
	>$FILETO
	NAME="$(get_dear_from_fio "$FULLNAME" "покупатель")"
	BETA=""
	# FIXME: is it used?
	if [ "$RELEASECANDIDAT" = "1" ] ; then
		BETA="
!! Это предварительная версия продукта, используйте её с осторожностью !!
!! Устанавливайте в повседневное использование только после проверки !!
!! Создавайте резервные копии !!
"
	fi

CIFSTEXT=""
if [ "$TYPE" != "Local" ] ; then
CIFSTEXT=" - пакет для обеспечения сетевого взаимодействия по протоколу CIFS с сервером
   SAMBA или Windows Server (etercifs) (и dkms-etercifs - только если нужен)
"
fi

if [ "$TYPE_LICENSE" = "Demo" ] || [ "$TYPE_LICENSE" = "DemoTerminal" ] ; then
	THANKTEXT="Благодарим Вас за внимание к нашему продукту."
else
	THANKTEXT="Благодарим Вас за покупку!"
fi

	cat >>$FILETO <<EOF
${DEAR} ${NAME}!

Ваш заказ по сборке для системы ${TEXTDIST} Продукта
${PRODUCT}
(релиз $PROJECTVERSION) выполнен.
${BETA}
Регистрационный номер Продукта: ${ETERREGNUM}.

Для получения Продукта необходимо скачать файлы по приведённым ссылкам, в их числе:
 - пакеты Продукта (wine-etersoft, wine-etersoft-$PRODUCT_name);
 - файл лицензии WINE-ETERSOFT.LIC;
 - документацию (файл manual.html);
 - пакеты с драйверами и менеджерами лицензий для аппаратных ключей защиты
   HASP 4/HL/SRM, Smartkey 3 Eutron и SafeNet Sentinel (пакет haspd и haspd-modules, dkms-aksparlnx для HASP LPT);
 - пакет со свободными шрифтами Liberation (fonts-ttf-liberation)
   Во многих дистрибутивах он уже есть (в Ubuntu называется ttf-liberation),
   ставить наш вариант не обязательно.
$CIFSTEXT
ОБРАТИТЕ ВНИМАНИЕ!
Файл лицензии WINE-ETERSOFT.LIC необходимо расположить в каталоге /etc/wine, ~/.wine или
C:\WINDOWS\INF.
EOF
	printURL "$FTPDIR" "$DOWNLOADDIR/$TYPE-$PROJECTVERSION/$DIST" $FTPDIR/WINE-ETERSOFT.LIC >>$FILETO || fatal "Error with WINE-ETERSOFT.LIC "
	cat >>$FILETO <<EOF

Для полного соответствия шрифтов в программах
можно скачать и установить пакет fonts-ttf-ms,
содержащий шрифты MS Core Fonts:
$PUBDOWNLOAD1FONTS

Ссылки для скачивания файлов экземпляра Продукта и сопутствующих файлов:
EOF
	printURL "$FTPDIR" "$DOWNLOADDIR/$TYPE-$PROJECTVERSION/$DIST" `find -L $FTPDIR -maxdepth 1 -type f | sort | grep -v WINE-ETERSOFT.LIC` >>$FILETO || fatal "Error with files (files are missed) "

	cat >>$FILETO <<EOF
(действительны в течение 4 суток)

Если адрес $DOWNLOADDOMAIN недоступен, используйте ftp2.etersoft.ru для доступа к файлам (см. ссылку ниже).

Вы можете напрямую зайти в каталог, чтобы загрузить файлы открытой и закрытой части:
	${DOWNLOADDIR/ftp:/http:}/$TYPE-$PROJECTVERSION/$DIST
	${DOWNLOADDIR}/$TYPE-$PROJECTVERSION/$DIST
	${DOWNLOADDIR/download/ftp2}/$TYPE-$PROJECTVERSION/$DIST

Обязательно ознакомьтесь с известными проблемами в текущей сборке:
http://wiki.etersoft.ru/WINE/knownbugs

Ответы на частые вопросы смотрите на http://etersoft.ru/wine/faq

Прочитайте документацию http://etersoft.ru/wine/manual

По вопросам использования продукта пишите новое письмо
на support@etersoft.ru,
указав в ТЕМЕ (Subject) письма регистрационный номер.

Пожалуйста, отвечайте на это письмо только
при возникновении затруднений со скачиванием файлов.

$THANKTEXT
-- 
Команда разработчиков
Etersoft, 2010
EOF
}

build_wine_etersoft()
{
	PROJECTNAME="WINE@Etersoft"
	VERNAME=$PROJECTNAME/$PROJECTVERSION

	TARGETDIR="/var/ftp/pub/download/WINE@Etersoft/$TARGETDIRNAME"
	DOWNLOADDIR="ftp://$DOWNLOADDOMAIN/W@E/$TARGETDIRNAME"

	PUBLOCAL="/var/ftp/pub/Etersoft/$VERNAME"

	# Use real path if possible
	if [ -L "$PUBLOCAL" ] ; then
		PUBLOCAL=`readlink -f "$PUBLOCAL"`
		VERNAME=$PROJECTNAME/`basename $PUBLOCAL`
	fi

	# Not: use original project version (other path, not pub)
	PVTLOCAL="/var/ftp/pvt/Etersoft/$PROJECTNAME/$PROJECTVERSION/WINE-$(get_product_type "$COMPONENTNAME")"

	if [ ! -d "$PUBLOCAL/WINE/$DIST" ] ; then
		warning "System $DIST not supported for build ($PUBLOCAL/WINE/$DIST does not exist)"
		do_broken
	fi
	
	TEXTDIST=$DIST
	# Check for linked system (собираем для основной системы)
	if [ -L "$PUBLOCAL/WINE/$DIST" ] ; then
		DIST=`readlink $PUBLOCAL/WINE/$DIST | sed -e "s|\.\./||g"`
		TEXTDIST="$TEXTDIST (фактически сборка выполнена для $DIST)"
	fi
	check_dist $DIST
	mkdir -p "$PVTLOCAL/$DIST"
	
	PUBDOWNLOAD1FONTS="http://$DOWNLOADDOMAIN/pub/Etersoft/$VERNAME/fonts/$DIST"

	TYPE="$(get_product_type "$COMPONENTNAME")"

	prepare_wine_etersoft

	# Для отправки писем обязательно нужна локаль!
	TMPMAIL=`mktemp`
	prepare_wine_etersoft_mail $TMPMAIL || fatal "Can't prepare letter"

	export LC_ALL=ru_RU.UTF-8
	cat $TMPMAIL | mutt "${FULLMAILTO}" -b "sales-track@etersoft.ru" -s "$ETERREGNUM: Сборка $COMPONENTNAME для ${TEXTDIST}" || fatal "Can't send"
	rm -f $TMPMAIL
}

