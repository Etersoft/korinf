#!/bin/sh
##
#  Korinf project
#
#  Gentoo build related functions
#
#  Copyright (c) Etersoft <http://etersoft.ru> 2005, 2006, 2007, 2009, 2013
#  Copyright (c) Vitaly Lipatov <lav@etersoft.ru> 2009, 2013
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.

#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.

#  You should have received a copy of the GNU Affero General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

kormod converts/alien

convert_gentoo()
{
	assert_var TARGETBULDNAME PACKAGEVERSION PACKAGERELEAE BUILTRPM BUILTBINPKGLIST
	prepare_convert
	PKGARCH=${PKGARCH/i586/x86}
	PKGARCH=${PKGARCH/x86_64/amd64}

	SRC_URI=
	for i in $BUILTBINPKGLIST ; do
	    run_alien --to-tgz $i || { warning "alien problem with tbz2"; RES=11 ; }
	    for j in *${BUILDNAME}*.tgz ; do
		local TARBNAME=`basename $j .tgz`
		local depf=$(get_pkgname_from_filename $j)
		local FNAME=$depf-$PACKAGEVERSION-$PACKAGERELEASE$PKGVENDOR.$PKGARCH.$PKGFORMAT
		cat "$j" | gunzip -c | bzip -c > $FNAME || { warning "can't repack files" ; RES=11 ; }
			SRC_URI="$SRC_URI \$BASE_URI/$FNAME"
		rm -f "$j"
	    done
	done

# TODO: requires
	cat > $BUILTRPM/$TARGETBUILDNAME-$PACKAGEVERSION-$PACKAGERELEASE.ebuild << EOF
# Copyright 2013 Etersoft
# Gentoo ebuild file generated by Korinf build system

EAPI="3"
DESCRIPTION="$PKGCOMMENT"
HOMEPAGE=$PKGURL

LICENSE=$PKGLICENSE
SLOT="0"
KEYWORDS="-* x86 amd64"

RDEPEND="$(estrlist list $PKGREQLIST)"

BASE_URI=$DESTURL
SRC_URI="$SRC_URI"


src_unpack() {
unpack \${A}
}

src_install() {
cp -pR * "\${D}"
}
EOF

}
