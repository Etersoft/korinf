#!/bin/bash
##
#  Korinf project
#
#  Arch Linux build related functions
#
#  Copyright (c) Etersoft <http://etersoft.ru> 2005, 2006, 2007, 2009
#  Copyright (c) Vitaly Lipatov <lav@etersoft.ru> 2009
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

kormod mount copying install log
kormod_build main

exit_handler()
{
    local rc=$?
    trap - EXIT
    warning "Interrupted, exiting..."
    end_umount
    exit $rc
}



main_build_phase()
{
	# On systems with portage change wine package name
	# TODO: remove BUILDNAME or PACKAGE
	[ "$BUILDNAME" = "wine" ] && PACKAGE="wine-etersoft-public" || PACKAGE=$BUILDNAME

	# TODO: remove
	[ -n "$PRODUCT" ] && EPACKAGE=$PACKAGE-$PRODUCT || EPACKAGE=$PACKAGE

	# Do use direct package name?
	if echo $BUILDNAME | grep -q "\.src\.rpm" ; then
		BUILDSRPM="$SOURCEPATH/$BUILDNAME"
	else
		BUILDSRPM="$SOURCEPATH/$(ls -1 $SOURCEPATH/$BUILDNAME-[0-9]*.src.rpm | last_rpm).src.rpm"
	fi

	[ -r "$BUILDSRPM" ] || fatal "Package $BUILDSRPM is not readable"

	logit "`basename $BUILDSRPM .src.rpm`"
	
	# FIXME: move it to log_it?
	#if [ -z "$NIGHTBUILD" ] ; then
	#	rpm --checksig $BUILDSRPM || warning "GPG check failed"
	#fi

	# fill after hasher
	BUILTBINPKGLIST=

	if [ -n "$MAKESPKG" ] ; then
		build_src_pkg || return 1
	else
		build_in_dist || return 1
	fi
	logit "copying log" copying_log || return 1
}


main_build()
{

# Try to set clear environment
export LC_ALL=C
unset DISPLAY

trap exit_handler EXIT HUP INT QUIT PIPE TERM

[ -n "$ADEBUG" ] && echo "BUILDNAME: $BUILDNAME"

CMDRE=$(get_distro_list $REBUILDLIST)
[ -z "$CMDRE" ] && fatal "build list is empty"

# HACK: Url for remote building
SOURCEURL=$(echo $SOURCEPATH | sed -e "s|/var/ftp/|ftp://server/|g")

for dist in $CMDRE ; do
	# Куда будем складывать собранные пакеты
	DESTDIR=$TARGETPATH/$dist
	# FIXME: Hack
	[ "$TARGETPRIVPATH" ] && DESTDIR=$TARGETPRIVPATH

	dist_ver=`echo $dist | sed -e "s|.*/||g"`
	dist_name=`echo $dist | sed -e "s|/.*||g"`
	[ -z "$dist_name" ] && fatal "Empty dist_name for $dist"

	# Initialize LOGDIR and LOGFILE variables
	init_dist_log "$dist"

	# Run build and check result
	if ! main_build_phase ; then
		# Размонтируем при ошибке, если не указано обратное
		if [ -z "$ADEBUG" ] ; then
			logit "umount" end_umount
		fi
		# Если сборка с автоспеком провалилась, опубликуем логи
		logit "copying log from broken build" copying_log

		# Если автосборка, останавливаемся на ошибке
		if [ -n "$NIGHTBUILD" ] ; then
			echo `date` $dist FATAL | write_report
			fatal "Fatal autobuild"
		fi
	fi

	echo `date` $dist DONE | write_report

done

# disable trap before exit
trap - EXIT
}
