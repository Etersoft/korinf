#!/bin/sh
##
#  Korinf project
#
#  Common rpm build packages in chrooted Linux system
#
#  Copyright (c) Etersoft <http://etersoft.ru> 2005, 2006, 2007, 2009
#  Copyright (c) Vitaly Lipatov <lav@etersoft.ru> 2009
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.

#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.

#  You should have received a copy of the GNU Affero General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##

# We believe BUILDERHOME is clean already here

kormod buildargs
load_mod repl

check_alien()
{
    if (alien -h 2>&1 | grep -qws "depends" ); then
	return 0
    else
	warning "Error: `alien -V` not support \"--depends\" option..."
	return 1
    fi
}

# used BUILDERHOME to put in src.rpm
convert_rpm_to_target()
{
	local dist=$1

        [ -n "$BUILDERHOME" ] || BUILDERHOME=~/tmp/korinfer

	# rpmbph will use DISTRNAME/DISTRVERSION and so on

	# FIXME: when build to remote dist, we need generic src.rpm
	echo "Convert '$BUILDSRPM' for $dist distro"
	rm -f $BUILDERHOME/tmp/$BUILDNAME*
	if [ -n "$MAKESPKG" ] ; then
		$RPMBPH -v -n -z $BUILDSRPM
		BUILTRPM=~/$RPMSDIR
		return 0
	else
		ETERDESTSRPM=$BUILDERHOME/tmp $RPMBPH -v -n $BUILDSRPM
		BUILTRPM=$BUILDERHOME/$RPMSDIR
	fi

	# Get real src.rpm name
	TARGETSRPM=$(echo $BUILDERHOME/tmp/$BUILDNAME*.src.rpm | head -n1)
	[ -r "$TARGETSRPM" ] && [ -f "$TARGETSRPM" ] || { warning "Can't read target $TARGETSRPM src.rpm" ; return 1 ; }
	$SUDO chown $LOCUSER $TARGETSRPM

	return 0
}

# set target vars before package build
# can change BUILDARCH
set_target_var()
{
	# defines PKGFORMAT, PKGVENDOR, RPMVENDOR
	set_target_pkg_env # (from etersoft-build-utils)

	[ -z "$PKGFORMAT" ] && { warning "PKGFORMAT is empty" ; return 1 ; }

	[ "$PKGVENDOR" = "gentoo" ] || return 0

	# HACK for Gentoo
	if [ -n "$BOOTSTRAP" ] ; then
		[ "$PKGFORMAT" = "tbz2" ] && PKGFORMAT=rpm
	else
		[ "$PKGFORMAT" = "tbz2" ] && PKGFORMAT=tar.bz2
	fi
	return 0
}

build_rpms()
{
	local dist=$1

	# create needed files in home directory
	init_home
	INTBUILT=/home/$INTUSER/$RPMSDIR

	RPMARGS="$(get_rpm_args $dist $BUILDNAME)"

	echo "Build '$BUILDSRPM' for $dist distro with args '$RPMARGS'"
	# FIXME: problem if system's rpm does not recognize our src.rpm (as Mandriva 2007.1/2008)
	RPMBUILDROOT="/home/$INTUSER/tmp/$BUILDNAME-buildroot"

	RPMBUILDNODEPS=""
	# Skip buildreqs checking on non RPM systems
	[ "$PKGFORMAT" = "rpm" ] || RPMBUILDNODEPS="--nodeps"
	# hack: we set target to rpm before for Gentoo
	[ "$PKGVENDOR" = "gentoo" ] && RPMBUILDNODEPS="--nodeps"

	# TODO: we need do strip with some rpm rule? or during binary rpm converting
	# --without debug is wine only hack
	DISABLEDEBUGFLAG=""
	[ "$PKGFORMAT" = "rpm" ] || DISABLEDEBUGFLAG="--without debug"
	[ "$ALLOWPUBLICDEBUG" = "1" ] || DISABLEDEBUGFLAG="--without debug"

	CMDBUILD="rpmbuild -v --rebuild $RPMBUILDNODEPS "$RPMARGS" $DISABLEDEBUGFLAG --define='_unpackaged_files_terminate_build 0' --buildroot $RPMBUILDROOT /home/$INTUSER/tmp/$(basename $TARGETSRPM) --target $BUILDARCH"
	CMDAFTERBUILD="cat ~/tmp/rpm-tmp.* ; cat ~/$RPMSDIR/../BUILD/${BUILDNAME}*/config.log; cat ~/$RPMSDIR/../BUILD/${BUILDNAME}*/config.h ; cat ~/$RPMSDIR/../BUILD/${BUILDNAME}*/include/config.h"

	# Control file for check build result
        LOGFAILFILE="$BUILDERHOME/RPM/log/$BUILDNAME.log.failed"
	rm -f "$LOGFAILFILE" "$LOGFAILFILE.clog"

	echo "Chrooting as $INTUSER and run $CMDBUILD command in $BUILDARCH system"
	$NICE setarch $BUILDARCH $SUDO chroot $BUILDROOT \
		su - $INTUSER -c "export LANG=C ; export LC_MESSAGES=C ; umask 002 ; mkdir -p ~/RPM/log ; rm -f ~/tmp/rpm-tmp.* ; $CMDBUILD || touch ~/RPM/log/$BUILDNAME.log.failed ; ( $CMDAFTERBUILD ) >~/RPM/log/$BUILDNAME.log.failed.clog "

	if [ -r "$LOGFAILFILE" ] ; then
		rm -f "$LOGFAILFILE" ; warning "build failed"
		[ -r "$LOGFAILFILE.clog" ] && mv "$LOGFAILFILE.clog" "${LOGFILE/.log/.conf.log}"
		return 1
	fi

	# Workaround again flow target dirs
	pushd $BUILTRPM || { warning "can't chdir to $BUILTRPM" ; return 1; }
	test -d i586 && mv -f i586/* ./
	test -d x86_64 && mv -f x86_64/* ./
	test -d noarch && mv -f noarch/* ./
	popd
	return 0
}


run_alien()
{
	local VERBCOMMAND=
	[ -n $ADEBUG ] && VERBCOMMAND="--veryverbose"
	BUILDARCH=$BUILDARCH CC=$KORINFDIR/korinf/helpers/gcc-stub-dumpmachine fakeroot setarch $BUILDARCH alien --keep-version $VERBCOMMAND $@ || return
	# don't remove original due using rpm after converting (f.i. for Gentoo)
}

# Converts ALT Linux Sisyphus dependencies to target notation
# and print out result dependencies
# needs TARGETPATH, DISTRVENDOR, BUILDARCH, PKGFORMAT and so one
# call with packagename
get_target_deplist()
{
	local depf="$1"
	local depfile=$TARGETPATH/ALTLinux/Sisyphus/log/$depf.rpm.depends
	if [ ! -r $depfile ]; then
		warning "Cannot locate '$depfile' file"
		return 1
	fi
	listdep=`cat $depfile | sort -u`
	repl_list=$(print_pkgrepl_list)
	#[ -n "$VERBOSE" ] && alert "Used replacement file order: $repl_list"

	local j
	for j in $listdep; do
		tolocal_anyrepl $j $repl_list && echo "$TARGETPKGNAME" || echo $j
	done | sort -u
}

convert_rpm_to_deb()
{
	local RELPKG=$PACKAGERELEASE$PKGVENDOR
	local RES=0
	local DEPPARAM=""

	local PACKAGESLIST="$EXPRPMMAINFILES $EXPRPMEXTRAFILES"
	echo "Packages to convert: $PACKAGESLIST"
	for i in $PACKAGESLIST ; do
		if [ -e $i ] ; then
			local depf=$(get_pkgname_from_filename $i)
			if get_target_deplist $depf | tee $DESTDIR/log/$depf.deb.depends ; then
				if check_alien ; then
					DEPPARAM="--depends $DESTDIR/log/${depf}.deb.depends"
					alert "Call alien with ${DEPPARAM}"
				fi
			else
				rm -f $DESTDIR/log/$depf.deb.depends
			fi
			run_alien --scripts --to-$PKGFORMAT ${DEPPARAM} $i || { warning "alien problem with $PKGFORMAT"; RES=1 ; return $RES ; }
		else
			warning "Package $i is missed in $DESTDIR"
		fi
	done

	return $RES
}

convert_by_target()
{
	local RELPKG=$PACKAGERELEASE$PKGVENDOR
	local RES=0
	local DEPPARAM=""

	local PACKAGESLIST="$EXPRPMMAINFILES $EXPRPMEXTRAFILES"
	echo "Packages to convert: $PACKAGESLIST"
	for i in $PACKAGESLIST ; do
		if [ -e $i ] ; then
			run_alien --scripts --to-$PKGFORMAT ${DEPPARAM} $i || { warning "alien problem with $PKGFORMAT"; RES=1 ; return $RES ; }
		else
			warning "Package $i is missed in $DESTDIR"
		fi
	done

	# Hack for tgz packages
	# FIXME: will broken with package without BUILDNAME inside
	if [ $PKGFORMAT == "tgz" ] ; then
	    for i in *${BUILDNAME}*.tgz ; do test -r "$i" && mv $i `basename $i .tgz`-$RELPKG.tgz ; done
	fi

	return $RES
}

# Only with $TARGET
convert_rpm()
{
	local RELPKG=$PACKAGERELEASE$PKGVENDOR.$BUILDARCH
	local RES=0
	pushd $BUILTRPM
	ls -l
	echo "Make target packages for $PKGFORMAT ($PKGVENDOR)"
#	echo "Packages to convert: $PACKAGESLIST"
#	[ -n "$PACKAGESLIST" ] || fatal "Empty packages list in convert_rpm"

	case $PKGVENDOR in
		"gentoo")
			# Gentoo
			convert_gentoo || fatal "Cannot convert for Gentoo"
			echo "Generate ebuild"
			gen_ebuild
			RES=$?
			;;
		"archlinux")
			# ArchLinux
			convert_archlinux
			RES=$?
			;;
		*)
			case $PKGFORMAT in
			    "deb")
				convert_rpm_to_deb
				RES=$?
				;;
			    "tgz")
				convert_by_target
				RES=$?
				;;
			    *)
				fatal "unknown $PKGFORMAT"
			esac
	esac

	popd
	return $RES
}

